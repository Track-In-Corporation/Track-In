name: Build and Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2. Build and Push (Happens on GitHub Agent)
      - name: Build and Push Docker Images
        run: |
          # Create the .env.prod file locally so Docker Compose can read variables if needed
          echo "${{ secrets.ENV }}" > .env.prod

          # Build the images defined in your compose file
          docker compose --env-file .env.prod -f compose.prod.yaml build

          # Push the images to Docker Hub
          docker compose --env-file .env.prod -f compose.prod.yaml push

      # 3. Deploy to Server
      - name: Deploy to Server
        run: |
          # --- CONFIGURATION ---
          SSH_KEY_PATH="$HOME/.ssh/ssh_key"
          SERVER_USER="${{ secrets.SERVER_USER }}"
          SERVER_IP="${{ secrets.SERVER_IP }}"
          SERVER_PATH="/home/$SERVER_USER/trackin"

          # --- SETUP SSH KEY ---
          mkdir -p "$(dirname "$SSH_KEY_PATH")"
          echo "${{ secrets.SERVER_PRIVATE_KEY }}" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"

          # --- SETUP REMOTE DIRECTORY ---
          ssh -o StrictHostKeyChecking=no -i "$SSH_KEY_PATH" "$SERVER_USER@$SERVER_IP" \
            "mkdir -p $SERVER_PATH"

          # --- COPY CONFIG FILES ONLY ---
          # We ONLY copy the compose file and the env file.
          # We do NOT copy the source code (src/) because the code is inside the Docker images now.
          scp -o StrictHostKeyChecking=no -i "$SSH_KEY_PATH" \
            compose.prod.yaml .env.prod \
            "$SERVER_USER@$SERVER_IP:$SERVER_PATH"

          # --- PULL AND RESTART ---
          ssh -o StrictHostKeyChecking=no -i "$SSH_KEY_PATH" "$SERVER_USER@$SERVER_IP" << EOF
            set -xe
            cd $SERVER_PATH

            # Pull the new images we just pushed
            docker compose --env-file .env.prod -f compose.prod.yaml pull

            # Restart containers (only recreates if image changed)
            docker compose --env-file .env.prod -f compose.prod.yaml up -d

            # Cleanup old images to save space
            docker image prune -f
          EOF
